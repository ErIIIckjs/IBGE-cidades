<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Cidades IBGE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .cidades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .cidade-btn {
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .cidade-btn:hover {
            background: #2980b9;
        }
        .btn-todas {
            background: #9b59b6;
        }
        .btn-todas:hover {
            background: #8e44ad;
        }
        .btn-download {
            background: #27ae60;
        }
        .btn-download:hover {
            background: #219653;
        }
        .btn-historico {
            background: #e67e22;
        }
        .btn-historico:hover {
            background: #d35400;
        }
        .btn-limpar {
            background: #e74c3c;
        }
        .btn-limpar:hover {
            background: #c0392b;
        }
        .resultado {
            margin-top: 30px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 5px;
            display: none;
        }
        .dados-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 3px;
        }
        .comparacao-tabela {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparacao-tabela th, .comparacao-tabela td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .comparacao-tabela th {
            background-color: #3498db;
            color: white;
        }
        .comparacao-tabela tr:hover {
            background-color: #f5f5f5;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
            margin: 20px 0;
        }
        .link-externo {
            color: #3498db;
            text-decoration: none;
        }
        .link-externo:hover {
            text-decoration: underline;
        }
        .acoes-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .btn-acao {
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .historico-tabela {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .historico-tabela th, .historico-tabela td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .historico-tabela th {
            background-color: #7f8c8d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåé Comparador de Cidades - IBGE</h1>
        
        <div class="cidades-grid">
            <button class="cidade-btn" onclick="buscarDados('sao_paulo')">
                S√£o Paulo
            </button>
            <button class="cidade-btn" onclick="buscarDados('rio_de_janeiro')">
                Rio de Janeiro
            </button>
            <button class="cidade-btn" onclick="buscarDados('belo_horizonte')">
                Belo Horizonte
            </button>
            <button class="cidade-btn" onclick="buscarDados('salvador')">
                Salvador
            </button>
            <button class="cidade-btn" onclick="buscarDados('fortaleza')">
                Fortaleza
            </button>
            <button class="cidade-btn btn-todas" onclick="buscarTodas()">
                Comparar Todas
            </button>
        </div>

        <div class="acoes-container">
            <button class="btn-acao btn-download" onclick="downloadCSV()">
                üì• Baixar CSV
            </button>
            <button class="btn-acao btn-historico" onclick="verHistorico()">
                üìã Ver Hist√≥rico
            </button>
            <button class="btn-acao btn-limpar" onclick="limparHistorico()">
                üóëÔ∏è Limpar Hist√≥rico
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>‚è≥ Coletando dados... Isso pode levar alguns segundos.</p>
        </div>

        <div id="resultado" class="resultado"></div>
    </div>

    <script>
        // URL base para API - funciona local e no Render
        const API_BASE = window.location.origin;

        function buscarDados(cidade) {
            showLoading(true);
            fetch(`${API_BASE}/dados/${cidade}`)
                .then(response => {
                    if (!response.ok) throw new Error('Erro no servidor');
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    if (data.success) {
                        exibirResultado(data);
                    } else {
                        alert('Erro: ' + data.error);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    alert('Erro na requisi√ß√£o: ' + error.message);
                });
        }

        function buscarTodas() {
            showLoading(true);
            fetch(`${API_BASE}/todas_cidades`)
                .then(response => {
                    if (!response.ok) throw new Error('Erro no servidor');
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    if (data.success) {
                        exibirComparacao(data.resultados);
                    } else {
                        alert('Erro: ' + data.error);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    alert('Erro na requisi√ß√£o: ' + error.message);
                });
        }

        function downloadCSV() {
            window.open(`${API_BASE}/download/csv`, '_blank');
        }

        function verHistorico() {
            showLoading(true);
            fetch(`${API_BASE}/historico`)
                .then(response => {
                    if (!response.ok) throw new Error('Erro no servidor');
                    return response.json();
                })
                .then(data => {
                    showLoading(false);
                    if (data.success) {
                        exibirHistorico(data.historico);
                    } else {
                        alert('Erro ao carregar hist√≥rico');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    alert('Erro na requisi√ß√£o: ' + error.message);
                });
        }

        function limparHistorico() {
            if (confirm('Tem certeza que deseja limpar todo o hist√≥rico?')) {
                fetch(`${API_BASE}/limpar_historico`, { 
                    method: 'POST' 
                })
                .then(response => {
                    if (!response.ok) throw new Error('Erro no servidor');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Hist√≥rico limpo com sucesso!');
                        document.getElementById('resultado').innerHTML = '';
                        document.getElementById('resultado').style.display = 'none';
                    }
                })
                .catch(error => {
                    alert('Erro ao limpar hist√≥rico: ' + error.message);
                });
            }
        }

        function exibirResultado(data) {
            const resultadoDiv = document.getElementById('resultado');
            let html = `
                <h2>üèôÔ∏è ${data.cidade}</h2>
                <p><strong>Fonte:</strong> <a href="${data.url}" class="link-externo" target="_blank">IBGE - ${data.cidade}</a></p>
                <h3>Dados Demogr√°ficos:</h3>
            `;

            html += `
                <div class="dados-item">
                    <strong>Localidade:</strong> ${data.dados.localidade || 'N/A'}
                </div>
                <div class="dados-item">
                    <strong>Popula√ß√£o:</strong> ${data.dados.populacao || 'N/A'}
                </div>
                <div class="dados-item">
                    <strong>Ano do Censo:</strong> ${data.dados.ano_censo || 'N/A'}
                </div>
                <div class="dados-item">
                    <strong>Data da Consulta:</strong> ${new Date(data.dados.timestamp).toLocaleString()}
                </div>
            `;

            resultadoDiv.innerHTML = html;
            resultadoDiv.style.display = 'block';
        }

        function exibirComparacao(resultados) {
            const resultadoDiv = document.getElementById('resultado');
            let html = `<h2>üìä Compara√ß√£o entre Cidades</h2>`;
            
            html += `
                <table class="comparacao-tabela">
                    <thead>
                        <tr>
                            <th>Cidade</th>
                            <th>Localidade</th>
                            <th>Popula√ß√£o</th>
                            <th>Ano do Censo</th>
                            <th>Fonte</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const [cidade, dados] of Object.entries(resultados)) {
                if (dados.success) {
                    html += `
                        <tr>
                            <td><strong>${cidade}</strong></td>
                            <td>${dados.dados.localidade || 'N/A'}</td>
                            <td>${dados.dados.populacao || 'N/A'}</td>
                            <td>${dados.dados.ano_censo || 'N/A'}</td>
                            <td><a href="${dados.url}" class="link-externo" target="_blank">Ver no IBGE</a></td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr>
                            <td><strong>${cidade}</strong></td>
                            <td colspan="4" style="color: red;">Erro: ${dados.error}</td>
                        </tr>
                    `;
                }
            }
            
            html += `</tbody></table>`;
            resultadoDiv.innerHTML = html;
            resultadoDiv.style.display = 'block';
        }

        function exibirHistorico(historico) {
            const resultadoDiv = document.getElementById('resultado');
            
            if (historico.length === 0) {
                resultadoDiv.innerHTML = `<h2>üìã Hist√≥rico de Consultas</h2><p>Nenhuma consulta realizada ainda.</p>`;
                resultadoDiv.style.display = 'block';
                return;
            }
            
            let html = `<h2>üìã Hist√≥rico de Consultas</h2><p>Total de registros: ${historico.length}</p>`;
            html += `
                <table class="historico-tabela">
                    <thead>
                        <tr>
                            <th>Cidade</th>
                            <th>Localidade</th>
                            <th>Popula√ß√£o</th>
                            <th>Ano</th>
                            <th>Data da Consulta</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const registro of historico) {
                html += `
                    <tr>
                        <td>${registro.cidade}</td>
                        <td>${registro.dados.localidade || 'N/A'}</td>
                        <td>${registro.dados.populacao || 'N/A'}</td>
                        <td>${registro.dados.ano_censo || 'N/A'}</td>
                        <td>${new Date(registro.timestamp_consulta).toLocaleString()}</td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            resultadoDiv.innerHTML = html;
            resultadoDiv.style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            if (!show) document.getElementById('resultado').style.display = 'block';
        }
    </script>
</body>
</html>